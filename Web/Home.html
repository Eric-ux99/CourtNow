<!DOCTYPE html>
<html>
    <head>
        <title>CourtNow Badminton Booking System</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width-device-width, initial=scale=1.0">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        
        <style>
            body{
                background-color: #448D47;
            }

            div{
                background-color: #FFFF00;
                width: auto;
                border: 1px solid black;
                text-align: center;
            }

            h2{
                margin-top: 20px;
                margin-left: auto;
                margin-right: auto;
                font-family: 'Times New Roman', Times, serif;
                font-weight: bolder;
                color: #FFFF00;
                font-size: 35px;
                text-align: center;

            }

            h4{
                margin-left: auto;
                margin-right: auto;
                font-family: 'Times New Roman', Times, serif;
                font-weight:900;
                color: #448D47;
                font-size: 28px;
            }

            table{
                margin-left: auto;
                margin-right: auto;
                background-color: #448D47;
                color:#FFFF00;
                text-align: left;
            }

            .signoutBtn{
                align-self: center;
            }

        </style>
    </head>

    <body>
        <h2>
            CourtNow Badminton Booking Information
        </h2>
        <div class="container mt-3">
            <br>
            <h4>Booking details</h4>
            <table class="table table-dark" id="table1">
                <thead>
                    <th>No.</th>
                    <th>Booking ID</th>
                    <th>Username</th>
                    <th>Area</th>
                    <th>Complex</th>
                    <th>Court</th>
                    <th>Date</th>
                </thead>

                <tbody id="tbody1">

    
                </tbody>
            </table>

            <p>
                <label>Select Booking No. for update or delete</label><br>
                <select id="bookingId" >
                    <option value="" disabled selected value>-- Select an option --</option>
                </select>
                &emsp; &emsp; &emsp; 
                <button id="deleteBtn">Delete Booking</button>
                <hr>
                <button id="signoutBtn" onclick="window.location.href='Login.html'; alert('Signed out successfully')">Sign Out</button>
            </p>
        </div>

        <script type="module">
            var bookNo = 0;
            var tbody = document.getElementById('tbody1');


            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.11.0/firebase-analytics.js";

            const firebaseConfig = {
                apiKey: /*Insert API KEY here*/,
                authDomain: /*Insert auth domain here*/,
                databaseURL: /*Insert database URL here*/,
                projectId: /*Insert project ID here*/,
                storageBucket: /*Insert Storage bucket here*/,
                messagingSenderId: /*Insert Sender ID here*/,
                appId: /*Insert APP ID here*/,
                measurementId: /*Insert Measurement ID here*/
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);

            import {
                    getFirestore, getDocs, collection, doc, getDoc, deleteDoc, deleteField
            }
            from "https://www.gstatic.com/firebasejs/9.11.0/firebase-firestore.js"


            //Function start
        
            function AddItem(username, area, complex, court, date, bookingId){
                let trow = document.createElement("tr");
                let td1 = document.createElement('td');
                let td2 = document.createElement('td');
                let td3 = document.createElement('td');
                let td4 = document.createElement('td');
                let td5 = document.createElement('td');
                let td6 = document.createElement('td');
                let td7 = document.createElement('td');

            
                td1.innerHTML = ++bookNo;
                td2.innerHTML = bookingId;
                td3.innerHTML = username;
                td4.innerHTML = area;
                td5.innerHTML = complex;
                td6.innerHTML = court;
                td7.innerHTML = date;                    

                trow.appendChild(td1);
                trow.appendChild(td2);
                trow.appendChild(td3);
                trow.appendChild(td4);
                trow.appendChild(td5);
                trow.appendChild(td6);
                trow.appendChild(td7);

                tbody.appendChild(trow);

                var opt = document.createElement('option');
                var select = document.querySelector('select');
                    
                opt.text = bookNo;
                opt.value = bookNo;
                    
                select.add(opt);

                
            }

            function AddAllItem(booking){
                bookNo = 0;

                tbody.innerHTML = "";
                booking.forEach(element => {
                    AddItem(element.username, element.area, element.complexName, element.courtName, element.time, element.bookingId );
                });

            }

            async function deleteBook(booking){
        
                var bookId, userId, area, complexId, courtId, date, slots;


                booking.forEach(element => {
                    bookId = element.bookingId;
                    userId = element.userId;
                    area = element.area;
                    complexId = element.complexId;
                    courtId = element.courtId;
                    date = element.date;
                    slots = element.slot;
                });

                slots = String(slots);

                var ref = doc(db, "Booking", bookId);
                var ref1 = doc(db, "User", userId, "Booking", bookId);
                var ref2 = doc(db, "AllCourts", area, "Complex", complexId, "Courts", courtId, date, slots);

                const docSnap = await getDoc(ref);
                const docSnap1 = await getDoc(ref1);
                const docSnap2 = await getDoc(ref2);

            
                if(!docSnap.exists() || !docSnap1.exists() || !docSnap2.exists())
                {
                    alert("Document does not exist...Please try again");
                    return;
                }

                await deleteDoc(ref)
                .then(() => {
                    alert("Data deleted successfully");
                    
                })
                .catch((error) => {
                    alert("Unsuccessful operation, error: " + error);
                });

                await deleteDoc(ref1)
                .then(() => {
                    
                })
                .catch((error) => {
                    alert("Unsuccessful operation, error: " + error);
                });

                await deleteDoc(ref2)
                .then(() => {
                    
                })
                .catch((error) => {
                    alert("Unsuccessful operation, error: " + error);
                });
            }

            const db = getFirestore(app);

            async function GetAllData(){
                const querySnapshot = await getDocs(collection(db, "Booking"));

                var bookings = [];

                querySnapshot.forEach(doc => {
                    bookings.push(doc.data());
                });

                AddAllItem(bookings);
            }

            async function getDataInDB(bookingID)
            {
                var e = document.getElementById("bookingId");
                var value = e.value;
                var text = e.options[e.selectedIndex].text;

                if(e.value == '')
                {
                    alert("Please select a booking No.");
                }
                else
                {
                    var temp = document.getElementById('table1');
                    var rowLength = temp.rows.length;

                    var bookId, userId, area;

                    var cells1 = temp.rows.item(value).cells;
                    var bookID = cells1.item(1).innerHTML;

                    var ref = doc(db, "Booking", bookID);
                    const docSnap = await getDoc(ref);

                    var data = [];

                    if(docSnap.exists())
                    {
                        data.push(docSnap.data());
                        deleteBook(data);
                    }
                    else
                        alert("Data is not found...Please try again");
                }  
            }

            document.getElementById("deleteBtn").addEventListener("click",function(){
                getDataInDB();       
            });

            window.onload = GetAllData;

        </script>
        
    </body>
</html>